"use strict";(self["webpackChunkmy_project"]=self["webpackChunkmy_project"]||[]).push([[8015],{8015:function(e,t,a){a.r(t),a.d(t,{save:function(){return x},saveAll:function(){return F},saveAs:function(){return R}});var r=a(7753),n=a(70375),o=a(13802),l=a(61681),s=a(78668),i=a(50516),u=a(75193),c=a(20692),y=a(8308),d=a(54957),f=a(81577),p=a(486),m=a(84513),w=a(31370);const v=o.Z.getLogger("esri.layers.FeatureLayer"),h="Feature Service";function b(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function I(e,t){if(t.type!==h)throw new n.Z("feature-layer:portal-item-wrong-type",b(e,`should have portal item of type "${h}"`))}async function S(e){if(await e.load(),(0,d.rQ)(e))throw new n.Z("feature-layer:save",b(e,"using an in-memory source cannot be saved to a portal item"))}function g(e,t){let a=(e.messages??[]).filter((({type:e})=>"error"===e)).map((({name:e,message:t,details:a})=>new n.Z(e,t,a)));if(t?.ignoreUnsupported&&(a=a.filter((({name:e})=>"layer:unsupported"!==e&&"symbol:unsupported"!==e&&"symbol-layer:unsupported"!==e&&"property:unsupported"!==e&&"url:unsupported"!==e))),a.length>0)throw new n.Z("feature-layer:save","Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:a})}async function N(e,t,a){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const r=e.write({},t);return g(t,a),r}function Z(e){const{layer:t,layerJSON:a}=e;return t.isTable?{layers:[],tables:[a]}:{layers:[a],tables:[]}}function K(e){(0,w.qj)(e,w.Kz.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,a)=>a.indexOf(e)===t)))}function D(e){const t=e.portalItem;if(!t)throw v.error("save: requires the portalItem property to be set"),new n.Z("feature-layer:portal-item-not-set",b(e,"requires the portalItem property to be set"));if(!t.loaded)throw new n.Z("feature-layer:portal-item-not-loaded",b(e,"cannot be saved to a portal item that does not exist or is inaccessible"));I(e,t)}async function J(e,t){return/\/\d+\/?$/.test(e.url??"")?Z(t[0]):O(e,t)}async function O(e,t){const{layer:{url:a,customParameters:r,apiKey:n}}=t[0];let o=await e.fetchData("json");o&&null!=o.layers&&null!=o.tables||(o=await P(o,{url:a??"",customParameters:r,apiKey:n},t.map((e=>e.layer.layerId))));for(const l of t)$(l.layer,l.layerJSON,o);return o}async function P(e,t,a){var r,n;e||(e={}),(r=e).layers||(r.layers=[]),(n=e).tables||(n.tables=[]);const{url:o,customParameters:l,apiKey:s}=t,{serviceJSON:i,layersJSON:u}=await(0,y.V)(o,{customParameters:l,apiKey:s}),c=A(e.layers,i.layers,a),d=A(e.tables,i.tables,a);e.layers=c.itemResources,e.tables=d.itemResources;const f=[...c.added,...d.added],p=u?[...u.layers,...u.tables]:[];return await T(e,f,o,p),e}function A(e,t,a){const n=(0,r.e5)(e,t,((e,t)=>e.id===t.id));e=e.filter((e=>!n.removed.some((t=>t.id===e.id))));const o=n.added.map((({id:e})=>({id:e})));return o.forEach((({id:t})=>{e.push({id:t})})),{itemResources:e,added:o.filter((({id:e})=>!a.includes(e)))}}async function T(e,t,a,r){const n=t.map((({id:e})=>new u["default"]({url:a,layerId:e,sourceJSON:r.find((({id:t})=>t===e))})));await(0,s.as)(n.map((e=>e.load()))),n.forEach((t=>{const{layerId:a,loaded:r,defaultPopupTemplate:n}=t;r&&!(0,l.Wi)(n)&&$(t,{id:a,popupInfo:n.toJSON()},e)}))}function $(e,t,a){e.isTable?L(a.tables,t):L(a.layers,t)}function L(e,t){if(!e)return;const a=e.findIndex((({id:e})=>e===t.id));-1===a?e.push(t):e[a]=t}function j(e){const{portalItem:t}=e;return(0,d.y2)(e)&&!e.dynamicDataSource&&!!t?.loaded&&t.type===h}async function E(e){if(!e?.length)throw new n.Z("feature-layer-utils-saveall:missing-parameters","'layers' array should contain at least one feature layer");await Promise.all(e.map((e=>e.load())));for(const r of e)if(!j(r))throw new n.Z("feature-layer-utils-saveall:invalid-parameters",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${b(r,"does not conform")}`,{layer:r});const t=e.map((e=>e.portalItem.id));if(new Set(t).size>1)throw new n.Z("feature-layer-utils-saveall:invalid-parameters","All layers in the 'layers' array should be loaded from the same portal item");const a=e.map((e=>e.layerId));if(new Set(a).size!==a.length)throw new n.Z("feature-layer-utils-saveall:invalid-parameters","'layers' array should contain only one instance each of layer or table in a feature service")}function k(e,t){var a,r;let n=p["default"].from(t);return n.id&&(n=n.clone(),n.id=null),(a=n).type??(a.type=h),(r=n).portal??(r.portal=f.Z.getDefault()),I(e,n),n}async function z(e,t){const{url:a,layerId:r,title:n,fullExtent:o,isTable:s}=e,i=(0,c.Qc)(a),u=(0,l.pC)(i)&&"FeatureServer"===i.serverType;t.url=u?a:`${a}/${r}`,t.title||(t.title=n),t.extent=null,!s&&(0,l.pC)(o)&&(t.extent=await(0,w.$o)(o)),(0,w.ck)(t,w.Kz.METADATA),(0,w.ck)(t,w.Kz.MULTI_LAYER),(0,w.qj)(t,w.Kz.SINGLE_LAYER),s&&(0,w.qj)(t,w.Kz.TABLE),K(t)}async function q(e,t,a){const r=e.portal;await(r?._signIn()),await(r?.user?.addItem({item:e,data:t,folder:a?.folder}))}const x=(0,s.Ds)(C);async function C(e,t){await S(e),D(e);const a=e.portalItem,r=(0,m.Y)(a),n=await N(e,r,t),o=await J(a,[{layer:e,layerJSON:n}]);return K(a),await a.update({data:o}),(0,i.D)(r),a}const F=(0,s.Ds)((async(e,t)=>{await E(e);const a=e[0].portalItem,r=(0,m.Y)(a),n=await Promise.all(e.map((e=>N(e,r,t)))),o=await J(a,e.map(((e,t)=>({layer:e,layerJSON:n[t]}))));return K(a),await a.update({data:o}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),(0,i.D)(r),a.clone()})),R=(0,s.Ds)(Y);async function Y(e,t,a){await S(e);const r=k(e,t),n=(0,m.Y)(r),o=Z({layer:e,layerJSON:await N(e,n,a)});return await z(e,r),await q(r,o,a),e.portalItem=r,(0,i.D)(n),r}},8308:function(e,t,a){a.d(t,{C:function(){return l},V:function(){return n}});var r=a(66341);async function n(e,t){let a=await l(e,t);a=a||{},a.layers=a.layers?.filter(o)||[];const r={serviceJSON:a};if((a.currentVersion??0)<10.5)return r;const n=await l(e+"/layers",t);return r.layersJSON={layers:n?.layers?.filter(o)||[],tables:n?.tables||[]},r}function o(e){return!e.type||"Feature Layer"===e.type}async function l(e,t){return(await(0,r["default"])(e,{responseType:"json",query:{f:"json",...t?.customParameters,token:t?.apiKey}})).data}},84513:function(e,t,a){a.d(t,{Y:function(){return l},h:function(){return o}});var r=a(3466),n=a(81577);function o(e){return{origin:"portal-item",url:(0,r.mN)(e.itemUrl),portal:e.portal||n.Z.getDefault(),portalItem:e,readResourcePaths:[]}}function l(e){return{origin:"portal-item",messages:[],writtenProperties:[],url:e.itemUrl?(0,r.mN)(e.itemUrl):null,portal:e.portal||n.Z.getDefault(),portalItem:e}}}}]);
//# sourceMappingURL=8015.8165a0b4.js.map